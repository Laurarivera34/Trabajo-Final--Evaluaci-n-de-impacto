---
title: "Trabajo final"
author: "Maria Camila Caraballo, Laura Sarif Rivera, Zaira Garcia"
output:
  pdf_document:
    latex_engine: xelatex
  word_document: default
geometry: top=1.5cm, bottom=1.5cm, left=2cm, right=2cm
output_dir: outputs
header-includes: \usepackage{adjustbox}
---

```{r setup, include= FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
knitr::opts_knit$set(root.dir = "C:/1. MECA/2025/EVALUACIACÓN DE IMPACTO- Raachid Raaj/Trabajo final/Trabajo-Final--Evaluaci-n-de-impacto")

tinytex::tlmgr_update(self = TRUE, all = TRUE)

if (!requireNamespace("tinytex", quietly = TRUE)) {
  install.packages("tinytex")
}

# Verificar si TinyTeX está instalado
if (tinytex::is_tinytex()) {
  message("TinyTeX detectado. Actualizando instalación...")

  # Actualizar gestor de paquetes (self) y todos los paquetes
  tinytex::tlmgr_update(self = TRUE, all = TRUE)

  message("✅ TinyTeX actualizado correctamente.")
} else {
  message("No se detecta TinyTeX. Si usas MikTeX o TeX Live, actualiza manualmente.")
}
```

```{r results='asis', echo=FALSE}
# Cargar liberias y paquetes

# Instalando pacman si se requiere
if (!require("pacman")) install.packages("pacman")

# Cargando los paquetes usando pacman
pacman::p_load(
  
  # A) Manipulación, limpieza y visualización de datos
  tidyverse,    # Colección de paquetes esenciales (incluye dplyr, ggplot2, etc.)
  dplyr,        # Manipulación de datos (ya incluido en tidyverse, pero lo dejamos explícito).
  ggplot2,      # Visualización de datos (incluido en tidyverse).
  scales,       # Manejo de escalas (ej. porcentajes, comas).
  skimr,        # Resúmenes estadísticos rápidos de data.frames.
  
  # B) Modelado y análisis estadístico/econométrico
  fixest,       # Modelos de efectos fijos de alto rendimiento.
  plm,          # Modelos para datos de panel.
  AER,          # Herramientas de econometría aplicada.
  lmtest,       # Pruebas de hipótesis para modelos de regresión.
  sandwich,     # Errores estándar robustos.
  survey,       # Análisis de encuestas complejas.
  
  # C) Importación, exportación y generación de reportes
  haven,        # Lectura/escritura de Stata, SAS, SPSS.
  stargazer,    # Tablas de regresión con formato publicable.
  knitr,        # Reportes dinámicos en RMarkdown.
  modelsummary, # Tablas y resúmenes comparativos de modelos.
  tinytex,      # Soporte para compilar a PDF con LaTeX en RMarkdown.
  readxl,
  janitor       #clean names
)

# Leer archivo excel
educacion <- read_excel("Datos/PANEL_DE_EDUCACION(2023).xlsx")
salud_servicios <- read_excel("Datos/PANEL_SALUD_Y_SERVICIOS.xlsx")
violencia <- read_excel("Datos/PANEL_CONFLICTO_Y_VIOLENCIA(2024).xlsx")

```

## Paso 1. Limpieza de datos 

```{r}
# estandarizar nombres de variables
educacion <- educacion %>% clean_names()
salud_servicios <- salud_servicios %>% clean_names()
violencia <- violencia %>% clean_names()

# renombrar variables 
salud_servicios <- salud_servicios %>%
  rename(codmpio = c_digo_dane_del_municipio,
         ano = a_o)

# convertirlo a numérico
educacion <- educacion %>%
  mutate(across(c(ano, codmpio), as.numeric))

salud_servicios <- salud_servicios %>%
  mutate(across(c(ano, codmpio), as.numeric))

violencia <- violencia %>%
  mutate(across(c(ano, codmpio), as.numeric))

# revisar na de las bases
colSums(is.na(educacion))
colSums(is.na(salud_servicios))
colSums(is.na(violencia))

# eliminar columnas casi vacias
educacion <- educacion %>% select(where(~ mean(is.na(.)) < 0.8))
salud_servicios <- salud_servicios %>% select(where(~ mean(is.na(.)) < 0.8))
violencia <- violencia %>% select(where(~ mean(is.na(.)) < 0.8))

# eliminar duplicados 
educacion <- educacion %>% distinct()
salud_servicios <- salud_servicios %>% distinct()
violencia <- violencia %>% distinct()

# pegar bases
base_total <- full_join(educacion, salud_servicios, violencia, by = c("codmpio", "ano"))

# Variables numéricas
num_vars <- base_total %>% select(where(is.numeric))

# Boxplot de outliers
boxplot(num_vars, main = "Distribución de variables numéricas (outliers posibles)")

# imputar con la mediana
base_total <- base_total %>%
  mutate(
    cobertura_energia = ifelse(is.na(cobertura_energia),
                               median(cobertura_energia, na.rm = TRUE),
                               cobertura_energia)
  )



```

## Paso 2. Estadísticas descriptivas
```{r}
# estadísticas descriptivas
educacion %>%
  group_by(anio) %>%
  summarise(total_estudiantes = sum(num_estudiantes, na.rm = TRUE),
            promedio_docentes = mean(num_docentes, na.rm = TRUE))


# gráfico de tendencias paralelas
base_total %>%
  group_by(anio, pdet) %>%
  summarise(media_turismo = mean(agencias_viajes, na.rm = TRUE)) %>%
  ggplot(aes(x = anio, y = media_turismo, color = factor(pdet))) +
  geom_line(size = 1.2) +
  geom_vline(xintercept = 2017, linetype = "dashed") +
  labs(title = "Tendencias del turismo formal en municipios PDET vs no PDET",
       color = "PDET")


```

## Paso 3. Modelos DiD
```{r}
modelo_did <- feols(
  agencias_viajes ~ pdet * post + cobertura_energia + cobertura_acueducto + cobertura_internet | cod_municipio + anio,
  cluster = ~subregion_pdet,
  data = base_total
)

summary(modelo_did)
```

