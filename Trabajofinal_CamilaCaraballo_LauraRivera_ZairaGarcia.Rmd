---
title: "Trabajo final"
author: "Maria Camila Caraballo, Laura Sarif Rivera, Zaira Garcia"
output:
  pdf_document:
    latex_engine: xelatex
  word_document: default
geometry: top=1.5cm, bottom=1.5cm, left=2cm, right=2cm
output_dir: outputs
header-includes: \usepackage{adjustbox}
---

```{r setup, include= FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
knitr::opts_knit$set(root.dir = "C:/1. MECA/2025/EVALUACIACÓN DE IMPACTO- Raachid Raaj/Trabajo final/Trabajo-Final--Evaluaci-n-de-impacto")

tinytex::tlmgr_update(self = TRUE, all = TRUE)

if (!requireNamespace("tinytex", quietly = TRUE)) {
  install.packages("tinytex")
}

# Verificar si TinyTeX está instalado
if (tinytex::is_tinytex()) {
  message("TinyTeX detectado. Actualizando instalación...")

  # Actualizar gestor de paquetes (self) y todos los paquetes
  tinytex::tlmgr_update(self = TRUE, all = TRUE)

  message("✅ TinyTeX actualizado correctamente.")
} else {
  message("No se detecta TinyTeX. Si usas MikTeX o TeX Live, actualiza manualmente.")
}
```

```{r results='asis', echo=FALSE}
# Cargar liberias y paquetes

# Instalando pacman si se requiere
if (!require("pacman")) install.packages("pacman")

# Cargando los paquetes usando pacman
pacman::p_load(
  
  # A) Manipulación, limpieza y visualización de datos
  tidyverse,    # Colección de paquetes esenciales (incluye dplyr, ggplot2, etc.)
  dplyr,        # Manipulación de datos (ya incluido en tidyverse, pero lo dejamos explícito).
  ggplot2,      # Visualización de datos (incluido en tidyverse).
  scales,       # Manejo de escalas (ej. porcentajes, comas).
  skimr,        # Resúmenes estadísticos rápidos de data.frames.
  
  # B) Modelado y análisis estadístico/econométrico
  fixest,       # Modelos de efectos fijos de alto rendimiento.
  plm,          # Modelos para datos de panel.
  AER,          # Herramientas de econometría aplicada.
  lmtest,       # Pruebas de hipótesis para modelos de regresión.
  sandwich,     # Errores estándar robustos.
  survey,       # Análisis de encuestas complejas.
  
  # C) Importación, exportación y generación de reportes
  haven,        # Lectura/escritura de Stata, SAS, SPSS.
  stargazer,    # Tablas de regresión con formato publicable.
  knitr,        # Reportes dinámicos en RMarkdown.
  modelsummary, # Tablas y resúmenes comparativos de modelos.
  tinytex,      # Soporte para compilar a PDF con LaTeX en RMarkdown.
  readxl,
  kableExtra,
  janitor       #clean names
)

# Leer archivo excel
educacion <- read_excel("Datos/PANEL_DE_EDUCACION(2023).xlsx")
salud_servicios <- read_excel("Datos/PANEL_SALUD_Y_SERVICIOS.xlsx")
violencia <- read_excel("Datos/PANEL_CONFLICTO_Y_VIOLENCIA(2024).xlsx")
gobierno <- read_excel("Datos/PANEL_BUEN_GOBIERNO(2024).xlsx")
caracteristicas <- read_excel("Datos/PANEL_CARACTERISTICAS_GENERALES(2024).xlsx")
mpiopdet <- read_excel("Datos/MunicipiosPDET.xlsx")

```

## Paso 1. Limpieza de datos

```{r}
# estandarizar nombres de variables
salud_servicios <- salud_servicios %>% clean_names()

# renombrar variables 
salud_servicios <- salud_servicios %>%
  rename(codmpio = c_digo_dane_del_municipio,
         ano = a_o)

# convertirlo a numérico
educacion <- educacion %>%
  mutate(across(c(ano, codmpio), as.numeric))

salud_servicios <- salud_servicios %>%
  mutate(across(c(ano, codmpio), as.numeric))

violencia <- violencia %>%
  mutate(across(c(ano, codmpio), as.numeric))

gobierno <- gobierno %>%
  mutate(across(c(ano, codmpio), as.numeric))

caracteristicas <- caracteristicas %>%
  mutate(across(c(ano, codmpio), as.numeric))

# pegar bases
base_total <- educacion %>%
  full_join(salud_servicios, by = c("codmpio", "ano")) %>%
  full_join(violencia, by = c("codmpio", "ano")) %>%
  full_join(gobierno, by = c("codmpio", "ano")) %>%
  full_join(caracteristicas, by = c("codmpio", "ano"))

# estandarizar nombres de variables
base_total <- base_total %>% clean_names()

# base CEDE
datoscede <- base_total %>%
  select(
    codmpio, ano,
    mdm_g_ejecur,
    df_desemp_fisc,
    mdm_g_gobayt,
    gandina, gcaribe, gpacifica, gorinoquia, gamazonia,
    sisben_pobl_1, sisben_pobl_2, sisben_pobl_3, sisben_pobl_4,
    sisben_pobl_5, sisben_pobl_6, sisben_pobl_7, sisben_pobl_8,
    sisben_pobl_9, sisben_pobl_10,
    altura, discapital, indrural,
    homicidios, extorsion, errad_manual, o_desap_for, o_secuest, t_establ_o
  )

# años seleccionados para el análisis
datoscede <- datoscede %>%
  filter(ano >= 2013 & ano <= 2021)

# para base larga con la variable de regiones y sisben
datoscede <- datoscede%>%
  pivot_longer(
    cols = c(gandina, gcaribe, gorinoquia, gpacifica, gamazonia),     names_to = "region",     values_to = "dummy_region"      
  )

datoscede <- datoscede%>%
  pivot_longer(
    cols = c(sisben_pobl_1, sisben_pobl_2, sisben_pobl_3, sisben_pobl_4, sisben_pobl_5, sisben_pobl_6, sisben_pobl_7, sisben_pobl_8, sisben_pobl_9, sisben_pobl_10),    
names_to = "poblacion_sisben",   
  values_to = "dummy_sisben")


# unir con mpio pdet
mpiopdet <- mpiopdet %>%
  rename(
    codmpio = `Código DANE Municipio`
  ) %>%
  mutate(
    codmpio = as.numeric(codmpio),
    pdet = 1
  ) %>%
  select(codmpio,pdet)

# se une la base de mpio pdet para clasificarlos 
datoscede <- datoscede %>%
  left_join(mpiopdet, by = "codmpio") %>%
  mutate(pdet = if_else(is.na(pdet), 0, 1))

# eliminar duplicados
datoscede <- datoscede %>%
  distinct(codmpio, ano, .keep_all = TRUE)

# eliminar na
datoscede <- datoscede %>%
  filter(!is.na(codmpio))

# verificacion de los 170 mpios PDET
datoscede %>%
  filter(pdet == 1) %>%
  summarise(total_pdet = n_distinct(codmpio))

# verificación de na
colSums(is.na(datoscede))
```

## Paso 2. Estadísticas descriptivas

```{r}
# estadísticas descriptivas por grupo PDET
vars_interes <- c("indrural", "discapital", "df_desemp_fisc",
                  "homicidios", "extorsion", "t_establ_o")

nombres_descriptivos <- c(
  "Porcentaje rural",
  "Porcentaje en capital",
  "Desempleo fiscal (%)",
  "Número de homicidios",
  "Número de extorsiones",
  "Número de establecimientos oficiales"
)

# Crear tabla vertical con estadísticas
tabla_aer <- datoscede %>%
  filter(pdet %in% c(0,1)) %>%
  select(pdet, all_of(vars_interes)) %>%
  pivot_longer(
    cols = all_of(vars_interes),
    names_to = "variable",
    values_to = "valor"
  ) %>%
  group_by(pdet, variable) %>%
  summarise(
    Min = min(valor, na.rm = TRUE),
    Max = max(valor, na.rm = TRUE),
    Promedio = mean(valor, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = pdet,
    values_from = c(Min, Max, Promedio),
    names_prefix = "pdet_"
  ) %>%
  # Reemplazar nombres de variables por descriptivos
  mutate(variable = nombres_descriptivos)

# Crear tabla AER
tabla_html <- tabla_aer %>%
  kable(
    caption = "Estadísticas descriptivas por municipio PDET y No PDET",
    digits = 2,
    format = "html",
    col.names = c(
      "Variable",
      "Min (No PDET)", "Max (No PDET)", "Promedio (No PDET)",
      "Min (PDET)", "Max (PDET)", "Promedio (PDET)"
    )
  ) %>%
  kable_classic(full_width = FALSE, html_font = "Cambria")

# guardar 
save_kable(tabla_html, "graficos-tablas/tabla_estadisticas_pdet.html")

# análisis univariado
datoscede %>%
  filter(pdet %in% c(0,1)) %>%
  pivot_longer(cols = all_of(vars_interes), names_to = "variable", values_to = "valor") %>%
  ggplot(aes(x = factor(pdet), y = valor, fill = factor(pdet))) +
  geom_boxplot() +
  facet_wrap(~variable, scales = "free") +
  scale_fill_manual(values = c("0" = "lightblue", "1" = "salmon"), labels = c("No PDET", "PDET")) +
  labs(x = "Grupo PDET", y = "Valor", fill = "Grupo") +
  theme_minimal()


# gráfico de tendencias paralelas



```

## Paso 3. Modelos DiD

```{r}

```
